const SHEET_ID = '1D9z47a_uYtvFwA_uKlwd85-l5dnRhSOShP6CC2kMfWA'; 
const DRIVE_FOLDER_ID = '1fkl0PoPHSroRRZSON5YBnup15KaXvJaa';

function doGet(e) {
  return ContentService.createTextOutput("üöÄ Web App is running. Send POST request to save data.");
}

function doPost(e) {
  try {
    const body = JSON.parse(e.postData.contents);

    // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï ‡πÄ‡∏ä‡πà‡∏ô 20/09/2025
    const sheetName = body.dateReceived;
    const ss = SpreadsheetApp.openById(SHEET_ID);
    let sh = ss.getSheetByName(sheetName);
    if (!sh) {
      sh = ss.insertSheet(sheetName);
      sh.appendRow([
        'Date of recive',
        'Picture of defect',
        'Picture of size Lable',
        'Picture of sole',
        'Model Number',
        'Gender',
        'Size',
        'Model Name',
        'Production code',
        'Factory code',
        'Quantity'
      ]);
    }

    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î defect pics (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 8)
    const defectUrls = (body.defectPics || []).map((b64, i) =>
      saveImg(b64, `defect_${Date.now()}_${i}.jpg`)
    );

    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î size label (1)
    const sizeUrl = saveImg(body.sizeLabel, `sizelabel_${Date.now()}.jpg`);

    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î sole (1)
    const soleUrl = saveImg(body.solePic, `sole_${Date.now()}.jpg`);

    // OCR ‚Üí ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô placeholder
    const ocrText = '';
    const parsed = parseSizeLabel(ocrText);

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ä‡∏µ‡∏ï
    sh.appendRow([
      body.dateReceived,
      defectUrls.join(', '),
      sizeUrl,
      soleUrl,
      parsed.modelNumber || '',
      parsed.gender || '',
      parsed.size || '',
      parsed.modelName || '',
      parsed.productionCode || '',
      parsed.factoryCode || '',
      Number(body.qty || 1)
    ]);

    return ContentService.createTextOutput('‚úÖ Saved to Google Sheet');
  } catch (err) {
    return ContentService.createTextOutput('‚ùå Error: ' + err.message);
  }
}

function saveImg(dataUrl, filename) {
  if (!dataUrl) return '';
  const m = dataUrl.match(/^data:(.+);base64,(.*)$/);
  if (!m) return '';
  const blob = Utilities.newBlob(Utilities.base64Decode(m[2]), m[1], filename);
  const file = DriveApp.getFolderById(DRIVE_FOLDER_ID).createFile(blob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  return file.getUrl();
}

// ‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô placeholder ‡∏£‡∏≠ OCR ‡∏à‡∏£‡∏¥‡∏á
function parseSizeLabel(text) {
  return {
    modelNumber: '',
    gender: '',
    size: '',
    modelName: '',
    productionCode: '',
    factoryCode: ''
  };
}

